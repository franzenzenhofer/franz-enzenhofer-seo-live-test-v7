import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as _}from"./registry-CQtYqYyA.js";import{L as l}from"./logger-CF98vYH4.js";import"./logs-DOAcrpKK.js";const q=(e,r)=>({...e,what:e.what&&e.what.length>0?e.what:r.name,ruleId:e.ruleId??r.id}),A=async(e,r,o,c)=>{const i=r.filter(t=>t.enabled);l.logDirectSend(e,"rules","start",{total:r.length,enabled:i.length,disabled:r.length-i.length,url:o.url||"unknown"});const a=[];let d=0;for(const t of r){if(!t.enabled){l.logDirectSend(e,"rule","skip",{id:t.id,name:t.name,reason:"disabled"});continue}d++;const s=`${t.id}-${Math.random().toString(36).slice(2,7)}`;l.logDirectSend(e,"rule","start",{id:t.id,name:t.name,index:d,total:i.length,ruleId:s});const u=performance.now();try{const h=await t.run(o,c),f=(performance.now()-u).toFixed(2),m=Array.isArray(h)?h:[h];m.forEach((g,w)=>{l.logDirectSend(e,"rule","result",{id:t.id,ruleId:s,index:w+1,type:g.type,message:typeof g.message=="string"&&g.message.length>100?g.message.slice(0,100)+"...":g.message,label:g.label})}),l.logDirectSend(e,"rule","done",{id:t.id,name:t.name,ruleId:s,duration:`${f}ms`,results:m.length}),a.push(...m.map(g=>q(g,t)))}catch(h){l.logDirectSend(e,"rule","error",{id:t.id,name:t.name,ruleId:s,error:String(h),duration:`${(performance.now()-u).toFixed(2)}ms`})}}return l.logDirectSend(e,"rules","done",{total:a.length,byType:{ok:a.filter(t=>t.type==="ok").length,info:a.filter(t=>t.type==="info").length,warn:a.filter(t=>t.type==="warn").length,error:a.filter(t=>t.type==="error").length}}),a},O=(e,r,o)=>{var y,D,v,b,x,k,F,E;const c=[...e].reverse().find(n=>n.t==="dom:document_idle"||n.t==="dom:document_end"),i=[...e].reverse().find(n=>n.t==="dom:document_end"),a=[...e].reverse().find(n=>n.t==="dom:DOMContentLoaded"),d=(((y=c==null?void 0:c.d)==null?void 0:y.html)||"").toString(),t=e.filter(n=>!!n.u&&n.t.startsWith("nav:")),s=((D=t[0])==null?void 0:D.u)||"",u=((v=t.length?t[t.length-1]:void 0)==null?void 0:v.u)||"",h=s||o()||"about:blank",f=e.filter(n=>n.t==="req:headers"),m=n=>(n||"").replace(/[?#].*$/,""),g=[...f].reverse().find(n=>m(n.u)===m(u)||m(n.u)===m(s))||f.find(n=>!!n.h)||f[f.length-1],w=((b=[...e].reverse().find(n=>n.t==="req:done"&&(n.u===u||n.u===s)))==null?void 0:b.s)||((x=[...e].reverse().find(n=>n.t==="req:done"))==null?void 0:x.s)||void 0,S=(g==null?void 0:g.h)||void 0,p=S?Object.fromEntries(Object.entries(S).map(([n,U])=>[n.toLowerCase(),String(U??"")])):void 0,$=p!=null&&p.status?parseInt(p.status,10):w,C=f.map(n=>n.u).filter(Boolean),M={firstUrl:s,lastUrl:u,rawHeaders:S,domIdleDoc:c!=null&&c.d?r(String(((k=c.d)==null?void 0:k.html)||"")):void 0,domEndDoc:i!=null&&i.d?r(String(((F=i.d)==null?void 0:F.html)||"")):void 0,domContentLoadedDoc:a!=null&&a.d?r(String(((E=a.d)==null?void 0:E.html)||"")):void 0,resources:C,status:$,headers:p};return{html:d,url:h,extra:M}},L=async e=>{try{let r=await fetch(e,{method:"HEAD",redirect:"follow"});if(r.status===405||r.status===501)try{r=await fetch(e,{method:"GET",redirect:"follow"})}catch{}const o={};return r.headers.forEach((c,i)=>o[i.toLowerCase()]=c),{status:r.status,headers:o}}catch{return{}}},R=async(e,r,o,c=L)=>{const i=o(e),{status:a,headers:d}=await c(r);return{html:e,url:r,doc:i,status:a,headers:d}},T=async(e,r,o,c=L)=>{const i=O(e,r,o);return{...await R(i.html,i.url,r,c),...i.extra}};l.setContext("offscreen");const H=async(e,r,o,c,i)=>{var h;l.logDirectSend(e,"offscreen","handle run start",{runId:o.id,events:o.ev.length,domDone:o.domDone,pageUrl:i||"(none)"});const a=performance.now(),d=f=>new DOMParser().parseFromString(f,"text/html");l.logDirectSend(e,"page","build start",{events:o.ev.length});const t=await T(o.ev,d,()=>i||"about:blank");l.logDirectSend(e,"page","build done",{url:t.url,htmlSize:((h=t.html)==null?void 0:h.length)||0,hasDoc:!!t.doc,status:t.status});const s=await A(e,_,t,{globals:c||{}}),u=(performance.now()-a).toFixed(2);return l.logDirectSend(e,"offscreen","handle run done",{runId:o.id,results:s.length,duration:`${u}ms`}),s};chrome.runtime.onMessage.addListener((e,r,o)=>{const c=e,{channel:i,id:a,tabId:d,data:t}=c;if(i!=="offscreen"||!d)return!1;const s=t;return(s==null?void 0:s.kind)==="runRules"||(s==null?void 0:s.kind)==="runTyped"?((async()=>{try{l.logDirectSend(d,"offscreen","receive",{id:a,kind:s.kind,pageUrl:s.pageUrl||"(none)"});const u=await H(d,s.rules||[],s.run,s.globals,s.pageUrl);l.logDirectSend(d,"offscreen","send results",{id:a,results:u.length}),chrome.runtime.sendMessage({channel:"offscreen",replyTo:a,data:u}),o==null||o("ok")}catch(u){l.logDirectSend(d,"offscreen","error",{id:a,error:String(u)}),o==null||o({error:String(u)})}})(),!0):!1});
