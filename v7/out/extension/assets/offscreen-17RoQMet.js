import{r as x}from"./registry-yHiKUKor.js";const H=async(n,s,o)=>{const r=[];for(const e of n){if(!e.enabled)continue;const c=await e.run(s,o);Array.isArray(c)?r.push(...c):r.push(c)}return r},T=(n,s,o)=>{var w,y,g,v,b,E,S,F;const r=[...n].reverse().find(t=>t.t==="dom:document_idle"||t.t==="dom:document_end"),e=[...n].reverse().find(t=>t.t==="dom:document_end"),c=[...n].reverse().find(t=>t.t==="dom:DOMContentLoaded"),h=(((w=r==null?void 0:r.d)==null?void 0:w.html)||"").toString(),d=n.filter(t=>!!t.u&&t.t.startsWith("nav:")),u=((y=d[0])==null?void 0:y.u)||"",f=((g=d.length?d[d.length-1]:void 0)==null?void 0:g.u)||"",_=u||o()||"about:blank",a=n.filter(t=>t.t==="req:headers"),l=t=>(t||"").replace(/[?#].*$/,""),m=[...a].reverse().find(t=>l(t.u)===l(f)||l(t.u)===l(u))||a.find(t=>!!t.h)||a[a.length-1],q=((v=[...n].reverse().find(t=>t.t==="req:done"&&(t.u===f||t.u===u)))==null?void 0:v.s)||((b=[...n].reverse().find(t=>t.t==="req:done"))==null?void 0:b.s)||void 0,p=(m==null?void 0:m.h)||void 0,i=p?Object.fromEntries(Object.entries(p).map(([t,O])=>[t.toLowerCase(),String(O??"")])):void 0,A=i!=null&&i.status?parseInt(i.status,10):q,C=a.map(t=>t.u).filter(Boolean),M={firstUrl:u,lastUrl:f,rawHeaders:p,domIdleDoc:r!=null&&r.d?s(String(((E=r.d)==null?void 0:E.html)||"")):void 0,domEndDoc:e!=null&&e.d?s(String(((S=e.d)==null?void 0:S.html)||"")):void 0,domContentLoadedDoc:c!=null&&c.d?s(String(((F=c.d)==null?void 0:F.html)||"")):void 0,resources:C,status:A,headers:i};return{html:h,url:_,extra:M}},L=async n=>{try{let s=await fetch(n,{method:"HEAD",redirect:"follow"});if(s.status===405||s.status===501)try{s=await fetch(n,{method:"GET",redirect:"follow"})}catch{}const o={};return s.headers.forEach((r,e)=>o[e.toLowerCase()]=r),{status:s.status,headers:o}}catch{return{}}},j=async(n,s,o,r=L)=>{const e=o(n),{status:c,headers:h}=await r(s);return{html:n,url:s,doc:e,status:c,headers:h}},k=async(n,s,o,r=L)=>{const e=T(n,s,o);return{...await j(e.html,e.url,s,r),...e.extra}},I=async(n,s,o)=>{const r=c=>new DOMParser().parseFromString(c,"text/html"),e=await k(s.ev,r,()=>location.href);return H(x,e,{globals:o||{}})};chrome.runtime.onMessage.addListener(async(n,s,o)=>{if((n==null?void 0:n.channel)!=="offscreen")return;const{id:r,data:e}=n;if((e==null?void 0:e.kind)==="runRules"||(e==null?void 0:e.kind)==="runTyped"){const c=await I(e.rules,e.run,e.globals);chrome.runtime.sendMessage({channel:"offscreen",replyTo:r,data:c})}o==null||o("ok")});
