import{l as m,r as T}from"./auth-BDvWn2GT.js";const q="src/offscreen.html",P=()=>{var e;return!!((e=chrome.offscreen)!=null&&e.createDocument)},S=async()=>{var e,t,n;if(!P())return!1;try{return await((t=(e=chrome.offscreen)==null?void 0:e.hasDocument)==null?void 0:t.call(e))||await((n=chrome.offscreen)==null?void 0:n.createDocument({url:q,reasons:[chrome.offscreen.Reason.DOM_PARSER],justification:"Run rules asynchronously in isolated doc"})),!0}catch{return!1}},E=async e=>{if(!await S())throw new Error("offscreen-unavailable");return new Promise((n,r)=>{const a=Math.random().toString(36).slice(2),u=setTimeout(()=>{chrome.runtime.onMessage.removeListener(i),r(new Error("offscreen-timeout"))},15e3);function i(s){const l=s;(l==null?void 0:l.channel)==="offscreen"&&(l==null?void 0:l.replyTo)===a&&(clearTimeout(u),chrome.runtime.onMessage.removeListener(i),n(l.data))}chrome.runtime.onMessage.addListener(i),chrome.runtime.sendMessage({channel:"offscreen",id:a,data:e}).catch(()=>{})})},N=e=>{const t=(e.split(":",1)[0]||"").toLowerCase();return t==="http"||t==="https"||t==="file"},j=e=>e.some(t=>t.t.startsWith("dom:")&&!!t.d&&typeof t.d.html=="string"&&t.d.html.length>0),D=e=>`results:${e}`,H=async(e,t)=>{var k,b;const{globalRuleVariables:n,googleApiAccessToken:r}=await chrome.storage.local.get(["globalRuleVariables","googleApiAccessToken"]),a={variables:n||{},googleApiAccessToken:r||null,events:t.ev,rulesUrl:chrome.runtime.getURL("src/sidepanel.html"),codeviewUrl:chrome.runtime.getURL("src/sidepanel.html#codeview")},u=((k=[...t.ev].reverse().find(o=>!!o.u))==null?void 0:k.u)||"",i=N(u);let s;if(!i){s=[{name:"system:runner",label:"Runner",type:"error",message:`Restricted page scheme (${u.split(":",1)[0]||""}://). Open an http(s) page to run rules.`}];const c=D(e),{[c]:f}=await chrome.storage.local.get(c),d=Array.isArray(f)?[...f,...s]:s;await chrome.storage.local.set({[c]:d});return}if(!j(t.ev)){await m(e,`runner:skip no-dom ev=${t.ev.length}`);return}try{const o=[...t.ev].reverse().find(d=>d.t.startsWith("dom:")),c=typeof((b=o==null?void 0:o.d)==null?void 0:b.html)=="string"?o.d.html.length:0,f=t.ev.filter(d=>d.t==="req:headers").length;await m(e,`runner:start ev=${t.ev.length} html=${c} reqs=${f}`),s=await E({kind:"runTyped",run:t,globals:a})}catch(o){const c=o instanceof Error?o.message:String(o);s=[{name:"system:runner",label:"Runner",type:"error",message:c.includes("offscreen-unavailable")?"Offscreen documents are unavailable. Please enable the permission or update Chrome.":c.includes("offscreen-timeout")?"Timed out waiting for offscreen document.":`Failed to run rules: ${c}`}]}const p=D(e),R=(await chrome.storage.local.get(p))[p],$=Array.isArray(R)?[...R,...s]:s;await chrome.storage.local.set({[p]:$}),await m(e,`runner:done added=${s.length} total=${$.length}`)},g=e=>`run:${e}`,v=async e=>{const{[g(e)]:t}=await chrome.storage.session.get(g(e));return t||null},O=async(e,t)=>{await chrome.storage.session.set({[g(e)]:t})},U=async(e,t)=>{const n=await v(e)||{id:Date.now(),ev:[]};n.ev.push(t),await O(e,n)},C=async e=>{const t=await v(e)||{id:Date.now(),ev:[]};t.domDone=!0,await O(e,t)},x=async e=>{const t=await v(e);return await chrome.storage.session.remove(g(e)),t},B=e=>`finalize:${e}`,y=async(e,t=3e3)=>{const n=B(e);try{await chrome.alarms.clear(n)}catch{}await chrome.alarms.create(n,{when:Date.now()+t})},_=e=>{chrome.alarms.onAlarm.addListener(t=>{t.name.startsWith("finalize:")&&e(Number(t.name.split(":")[1]))})},h=async(e,t)=>{if(await U(e,t),t.t.startsWith("dom:")){const n=t.d,r=typeof(n==null?void 0:n.html)=="string"?n.html.length:0;m(e,`${t.t} html=${r}`).catch(()=>{})}if(t.t==="nav:before"){const{"ui:autoClear":n}=await chrome.storage.local.get("ui:autoClear");m(e,`nav:before url=${t.u||""} autoClear=${n!==!1}`).catch(()=>{}),n!==!1&&await chrome.storage.local.remove(`results:${e}`);const{"ui:preserveLog":r}=await chrome.storage.local.get("ui:preserveLog");r!==!0&&await chrome.storage.session.remove(`logs:${e}`);return}t.t==="dom:document_idle"&&await y(e,200)},A=async e=>{await C(e),await y(e,200)};_(async e=>{const t=await x(e);t&&await H(e,t)});const W=()=>{chrome.webNavigation.onBeforeNavigate.addListener(e=>{e.frameId===0&&h(e.tabId,{t:"nav:before",u:e.url})}),chrome.webNavigation.onCommitted.addListener(e=>{e.frameId===0&&h(e.tabId,{t:"nav:commit",u:e.url})}),chrome.webNavigation.onHistoryStateUpdated.addListener(e=>{e.frameId===0&&h(e.tabId,{t:"nav:history",u:e.url})})},z=()=>{const e={urls:["http://*/*","https://*/*"]};chrome.webRequest.onBeforeSendHeaders.addListener(t=>{h(t.tabId,{t:"req:beforeHeaders",u:t.url})},e,["requestHeaders"]),chrome.webRequest.onHeadersReceived.addListener(t=>{const n=Object.fromEntries((t.responseHeaders||[]).map(r=>[r.name,r.value]));h(t.tabId,{t:"req:headers",u:t.url,h:n})},e,["responseHeaders"]),chrome.webRequest.onCompleted.addListener(t=>{h(t.tabId,{t:"req:done",u:t.url,s:t.statusCode})},e)},F=(e,t,n)=>{var u,i;const r=e,a=(r==null?void 0:r.tabId)||((u=t.tab)==null?void 0:u.id)||null;return(r==null?void 0:r.type)==="panel:runNow"&&a?(C(a).then(()=>y(a,0)).then(()=>n==null?void 0:n("ok")).catch(()=>n==null?void 0:n("err")),!0):(r!=null&&r.event&&a&&(h(a,{t:`dom:${r.event}`,d:r.data}),r.event==="document_idle"&&chrome.storage.local.get("ui:autoRun").then(s=>{s["ui:autoRun"]!==!1&&A(a)}).catch(()=>A(a))),e==="tabIdPls"&&a&&(n==null||n({tabId:a,url:(i=t.tab)==null?void 0:i.url})),!0)},V=()=>{chrome.runtime.onMessage.addListener((e,t,n)=>F(e,t,n))},J=async()=>{},w=(e,t="src/sidepanel.html")=>{chrome.sidePanel.setOptions({tabId:e,path:t,enabled:!0}).catch(()=>{}),chrome.sidePanel.open({tabId:e}).catch(async()=>{try{await chrome.action.setBadgeText({tabId:e,text:"Open"}),await chrome.action.setBadgeBackgroundColor({tabId:e,color:"#1b73e8"}),await chrome.action.setTitle({tabId:e,title:"Click to open Live Test"})}catch{}});try{const r=(chrome.runtime.getManifest().content_scripts||[]).flatMap(a=>a.js||[]);r.length&&(m(e,`inject:start ${JSON.stringify(r)}`).catch(()=>{}),chrome.scripting.executeScript({target:{tabId:e},files:r}).then(()=>m(e,"inject:done")).catch(()=>m(e,"inject:fail")))}catch{}},M=async()=>{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return(e==null?void 0:e.id)??null},G=()=>{chrome.commands.onCommand.addListener(async e=>{if(e==="open-sidepanel"){const t=await M();t&&w(t,"src/sidepanel.html")}}),chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"open_panel",title:"Open Live Test",contexts:["action","page"]})}),chrome.contextMenus.onClicked.addListener(async(e,t)=>{if(e.menuItemId==="open_panel"){const n=(t==null?void 0:t.id)??await M();n&&w(n,"src/sidepanel.html")}})},L="src/sidepanel.html";chrome.runtime.onInstalled.addListener(()=>{J()});chrome.action.onClicked.addListener(e=>{e.id&&w(e.id,L)});chrome.tabs.onActivated.addListener(async({tabId:e})=>{try{await chrome.sidePanel.setOptions({tabId:e,path:L,enabled:!0})}catch{}});chrome.tabs.onUpdated.addListener(async e=>{try{await chrome.sidePanel.setOptions({tabId:e,path:L,enabled:!0})}catch{}});W();z();V();G();T().catch(()=>{});addEventListener("unhandledrejection",e=>{var t;console.warn("[bg] unhandledrejection",e.reason),(t=e.preventDefault)==null||t.call(e)});addEventListener("error",e=>{var t;console.warn("[bg] error",(e==null?void 0:e.error)||(e==null?void 0:e.message)),(t=e.preventDefault)==null||t.call(e)});
