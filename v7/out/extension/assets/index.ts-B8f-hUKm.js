import{L as s}from"./logger-CF98vYH4.js";import{l as i,i as S,a as D,S as $,r as H,b as W,d as z,e as F}from"./logs-DOAcrpKK.js";import{w as V}from"./runMeta-CidP79Hf.js";import{a as J}from"./auth-DPFzHX6O.js";import{r as N}from"./tabMemory-Dq2TCuzT.js";const O="src/offscreen.html",Y=()=>{var e;return!!((e=chrome.offscreen)!=null&&e.createDocument)},G=async e=>{var n,r,o;return Y()?await((r=(n=chrome.offscreen)==null?void 0:n.hasDocument)==null?void 0:r.call(n))?(await s.logDirect(e,"offscreen","doc exists",{}),!0):(await s.logDirect(e,"offscreen","create doc",{url:O}),await((o=chrome.offscreen)==null?void 0:o.createDocument({url:O,reasons:[chrome.offscreen.Reason.DOM_PARSER],justification:"Run rules asynchronously in isolated doc"})),await s.logDirect(e,"offscreen","doc created",{}),!0):(await s.logDirect(e,"offscreen","no API support",{}),!1)},K=async(e,t)=>{if(await s.logDirect(e,"offscreen","call start",{}),!await G(e))throw await s.logDirect(e,"offscreen","ensure failed",{}),new Error("offscreen-unavailable");return await s.logDirect(e,"offscreen","send message",{}),new Promise((r,o)=>{const a=Math.random().toString(36).slice(2),l=setTimeout(()=>{chrome.runtime.onMessage.removeListener(c),s.logDirect(e,"offscreen","TIMEOUT",{id:a}),o(new Error("offscreen-timeout"))},15e3);function c(d){const h=d;(h==null?void 0:h.channel)==="offscreen"&&(h==null?void 0:h.replyTo)===a&&(clearTimeout(l),chrome.runtime.onMessage.removeListener(c),s.logDirect(e,"offscreen","got response",{id:a}),r(h.data))}chrome.runtime.onMessage.addListener(c),chrome.runtime.sendMessage({channel:"offscreen",id:a,tabId:e,data:t}).catch(d=>{clearTimeout(l),chrome.runtime.onMessage.removeListener(c),s.logDirect(e,"offscreen","send failed",{error:String(d)}),o(new Error("offscreen-message-failed"))})})},Q=e=>{const t=(e.split(":",1)[0]||"").toLowerCase();return t==="http"||t==="https"||t==="file"},X=e=>e.some(t=>t.t.startsWith("dom:")&&!!t.d&&typeof t.d.html=="string"&&t.d.html.length>0),Z=e=>{var r;const t=e.filter(o=>!!o.u&&o.t.startsWith("nav:"));return t.length&&t[t.length-1].u||""||((r=[...e].reverse().find(o=>!!o.u))==null?void 0:r.u)||""},b=e=>{const t=new Map;for(const a of e)t.set(a.t,(t.get(a.t)||0)+1);const n=[...t.entries()].sort((a,l)=>l[1]-a[1]).slice(0,6).map(([a,l])=>`${a}:${l}`).join(", "),r=e.filter(a=>a.t.startsWith("nav:")).length,o=e.filter(a=>a.t==="req:headers").length;return{top:n,navs:r,reqs:o}},I=e=>e.filter((t,n,r)=>t.name!=="system:runner"||r.findIndex(o=>o.name===t.name&&o.message===t.message)===n),ee=async(e,t,n,r)=>{const o=async a=>(await chrome.storage.local.set({[t]:a}),a.length);try{const a=I(Array.isArray(n)?[...n,...r]:r);return await o(a)}catch{try{return await o(r)}catch{const a=r.slice(-Math.max(10,Math.min(100,r.length)));return await o(a)}}},C=e=>`results:${e}`,te=async(e,t)=>{var T,A;const n=`run-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,r=new Date,{globalRuleVariables:o,googleApiAccessToken:a}=await chrome.storage.local.get(["globalRuleVariables","googleApiAccessToken"]),l={variables:o||{},googleApiAccessToken:a||null,events:t.ev,rulesUrl:chrome.runtime.getURL("src/sidepanel.html"),codeviewUrl:chrome.runtime.getURL("src/sidepanel.html#codeview"),runId:n,runTimestamp:r.toISOString()},c=Z(t.ev),d=X(t.ev),h=c?Q(c):d;let u;if(!c&&!d){await i(e,`runner:skip no-url-yet ev=${t.ev.length}`);return}if(!h){u=[{name:"system:runner",label:"Runner",type:"error",message:`Restricted page scheme (${c.split(":",1)[0]||""||"(none)"}://). Open an http(s) page to run rules.`}];const f=C(e),{[f]:p}=await chrome.storage.local.get(f);await chrome.storage.local.set({[f]:Array.isArray(p)?[...p,...u]:u});return}if(!d){await i(e,`runner:skip no-dom ev=${t.ev.length} url=${c||"(none)"}`);return}const y=C(e);await chrome.storage.local.remove(y),await i(e,"runner:cleared old results for new test");try{const m=[...t.ev].reverse().find(g=>g.t.startsWith("dom:")),f=typeof((T=m==null?void 0:m.d)==null?void 0:T.html)=="string"?m.d.html.length:0,p=b(t.ev);await i(e,`runner:start ev=${t.ev.length} url=${c||"(none)"} html=${f} navs=${p.navs} reqs=${p.reqs} top=[${p.top}]`);const _=((A=t.ev.find(g=>g.t.startsWith("nav:")&&typeof g.u=="string"))==null?void 0:A.u)||"(none)";await i(e,`runner:nav first=${_} last=${c||"(none)"}`),u=await K(e,{kind:"runTyped",run:t,globals:l,pageUrl:c});for(let g=0;g<u.length;g++)await i(e,`runner:result ${g+1}/${u.length} payload=${JSON.stringify(u[g])}`);await i(e,`runner:offscreen results=${u.length}`)}catch(m){const f=m instanceof Error?m.message:String(m);u=[{name:"system:runner",label:"Runner",type:"error",message:f.includes("offscreen-unavailable")?"Offscreen documents are unavailable. Please enable the permission or update Chrome.":f.includes("offscreen-timeout")?"Timed out waiting for offscreen document.":`Failed to run rules: ${f}`}]}const B=(await chrome.storage.local.get(y))[y],M=await ee(e,y,B,u).catch(async m=>(await i(e,`runner:save error ${String(m)}`),-1));M>=0&&(await V(e,{url:c||"(unknown)",ranAt:r.toISOString(),runId:n}),await i(e,`runner:done added=${u.length} total=${M}`))},v=e=>`run:${e}`,R=async e=>{const{[v(e)]:t}=await chrome.storage.session.get(v(e));return t||null},j=async(e,t)=>{await chrome.storage.session.set({[v(e)]:t})},re=async(e,t)=>{const n=await R(e)||{id:Date.now(),ev:[]};n.ev.push(t),await j(e,n)},ne=async e=>{const t=await R(e)||{id:Date.now(),ev:[]};t.domDone=!0,await j(e,t)},oe=async e=>{const t=await R(e);return await chrome.storage.session.remove(v(e)),t},ae=e=>`finalize:${e}`,U=async(e,t=3e3)=>{const n=ae(e);try{await chrome.alarms.clear(n)}catch{}await chrome.alarms.create(n,{when:Date.now()+t})},se=e=>{chrome.alarms.onAlarm.addListener(t=>{t.name.startsWith("finalize:")&&e(Number(t.name.split(":")[1]))})},w=async(e,t)=>{if(!S(e)){await D(`collector:drop tabId=${e??"null"} type="${t.t}"`);return}if(await s.logDirect(e,"event","receive",{type:t.t,url:t.u||"no-url",hasData:!!t.d,status:t.s}),await re(e,t),await s.logDirect(e,"event","add",{type:t.t,tabId:e}),t.t.startsWith("dom:")){const n=t.d,r=typeof(n==null?void 0:n.html)=="string"?n.html:"",o=r.length;i(e,`${t.t} html=${o}`).catch(a=>console.error("[collector] log failed",a)),await s.logDirect(e,"dom","event",{type:t.t,htmlSize:o,html:r.slice(0,500),htmlFull:r,url:t.u||"no-url"})}if(t.t==="nav:before"){const{"ui:autoClear":n}=await chrome.storage.local.get("ui:autoClear");i(e,`nav:before url=${t.u||""} autoClear=${n!==!1}`).catch(r=>console.error("[collector] log failed",r)),await s.logDirect(e,"nav","before",{url:t.u||"no-url",autoClear:n!==!1}),n!==!1&&(await chrome.storage.local.remove(`results:${e}`),await s.logDirect(e,"event","clear results",{reason:"autoClear"}));return}t.t==="dom:document_idle"&&(await s.logDirect(e,"event","schedule finalize",{reason:"dom:document_idle",delay:"200ms"}),await U(e,200))},E=async e=>{await s.logDirect(e,"event","mark dom done",{tabId:e}),await ne(e),await s.logDirect(e,"event","schedule finalize",{reason:"markDomPhase",delay:"200ms"}),await U(e,200)};se(async e=>{await s.logDirect(e,"alarm","fire",{tabId:e});const t=await oe(e);if(!t){await s.logDirect(e,"alarm","no run",{reason:"popRun returned null"});return}await s.logDirect(e,"alarm","execute",{runId:t.id,events:t.ev.length,domDone:t.domDone}),await te(e,t)});const ce=()=>{chrome.webNavigation.onBeforeNavigate.addListener(e=>{e.frameId===0&&w(e.tabId,{t:"nav:before",u:e.url})}),chrome.webNavigation.onCommitted.addListener(e=>{e.frameId===0&&w(e.tabId,{t:"nav:commit",u:e.url})}),chrome.webNavigation.onHistoryStateUpdated.addListener(e=>{e.frameId===0&&w(e.tabId,{t:"nav:history",u:e.url})})},ie=()=>{const e={urls:["http://*/*","https://*/*"]};chrome.webRequest.onBeforeSendHeaders.addListener(t=>{w(t.tabId,{t:"req:beforeHeaders",u:t.url})},e,["requestHeaders"]),chrome.webRequest.onHeadersReceived.addListener(t=>{const n=Object.fromEntries((t.responseHeaders||[]).map(r=>[r.name,r.value]));w(t.tabId,{t:"req:headers",u:t.url,h:n})},e,["responseHeaders"]),chrome.webRequest.onCompleted.addListener(t=>{w(t.tabId,{t:"req:done",u:t.url,s:t.statusCode})},e)},P=(e,t)=>{const n=t instanceof Error?t.message:String(t);console.error("[bg][logs]",n),e==null||e({error:n})},q=(e,t)=>{e==null||e(t)},le=e=>e===$||S(e),ue=(e,t,n)=>e!=="logs:get"&&e!=="logs:clear"?!1:le(t)?e==="logs:get"?((async()=>{try{const r=t===$?await H():await W(t);q(n,{logs:r})}catch(r){P(n,r)}})(),!0):((async()=>{try{t===$?await z():await F(t),q(n,{ok:!0})}catch(r){P(n,r)}})(),!0):(n==null||n({error:"Invalid tabId for logs request"}),!0),me=(e,t,n)=>{var a,l;const r=e,o=(r==null?void 0:r.tabId)||((a=t.tab)==null?void 0:a.id)||null;return(r==null?void 0:r.channel)==="log"&&r.message?S(o)?(i(o,r.message).catch(c=>console.error("[bg][log] failed",c)),!1):(D(`log:drop tabId=${o??"null"} message=${r.message.slice(0,120)}`).catch(()=>{}),!1):ue(r==null?void 0:r.type,o,n)?!0:r!=null&&r.event&&o?(w(o,{t:`dom:${r.event}`,d:r.data}),r.event==="document_idle"&&chrome.storage.local.get("ui:autoRun").then(c=>{c["ui:autoRun"]!==!1&&E(o)}).catch(()=>E(o)),!1):e==="tabIdPls"&&o?(n==null||n({tabId:o,url:(l=t.tab)==null?void 0:l.url}),!1):((r==null?void 0:r.channel)==="offscreen"||(r!=null&&r.channel||r!=null&&r.type)&&D(`runtime:unhandled channel=${(r==null?void 0:r.channel)||"none"} type=${(r==null?void 0:r.type)||"none"} tabId=${o??"null"}`).catch(()=>{}),!1)},he=()=>{chrome.runtime.onMessage.addListener((e,t,n)=>me(e,t,n))},fe=async()=>{},L=(e,t="src/sidepanel.html")=>{chrome.sidePanel.setOptions({tabId:e,path:t,enabled:!0}).catch(()=>{}),chrome.sidePanel.open({tabId:e}).catch(async()=>{try{await chrome.action.setBadgeText({tabId:e,text:"Open"}),await chrome.action.setBadgeBackgroundColor({tabId:e,color:"#1b73e8"}),await chrome.action.setTitle({tabId:e,title:"Click to open Live Test"})}catch{}});try{const r=(chrome.runtime.getManifest().content_scripts||[]).flatMap(o=>o.js||[]);r.length&&(i(e,`inject:start ${JSON.stringify(r)}`).catch(o=>console.error("[panel] log failed",o)),chrome.scripting.executeScript({target:{tabId:e},files:r}).then(()=>i(e,"inject:done").catch(o=>console.error("[panel] log failed",o))).catch(o=>{i(e,"inject:fail").catch(a=>console.error("[panel] log failed",a)),console.error("[panel] inject failed",o)}))}catch{}},x=async()=>{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return(e==null?void 0:e.id)??null},ge=()=>{chrome.commands.onCommand.addListener(async e=>{if(e==="open-sidepanel"){const t=await x();t&&L(t,"src/sidepanel.html")}}),chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"open_panel",title:"Open Live Test",contexts:["action","page"]})}),chrome.contextMenus.onClicked.addListener(async(e,t)=>{if(e.menuItemId==="open_panel"){const n=(t==null?void 0:t.id)??await x();n&&L(n,"src/sidepanel.html")}})},de=()=>{try{return chrome.runtime.getManifest().name.includes("(Dev)")}catch{return!1}},we=()=>{if(!de())return;let e="";const t=async()=>{try{const n=chrome.runtime.getURL("dev-reload.json")+`?ts=${Date.now()}`,r=await fetch(n,{cache:"no-store"});if(r.ok){const o=await r.text();if(o&&e&&o!==e){console.warn("[dev-reload] detected new build, reloading extension"),chrome.runtime.reload();return}o&&(e=o)}}catch{}setTimeout(t,1500)};t()};s.setContext("background");const k="src/sidepanel.html";chrome.runtime.onInstalled.addListener(()=>{fe()});chrome.action.onClicked.addListener(e=>{e.id&&L(e.id,k)});chrome.tabs.onActivated.addListener(async({tabId:e})=>{try{await chrome.sidePanel.setOptions({tabId:e,path:k,enabled:!0})}catch{}N(e).catch(()=>{})});chrome.tabs.onUpdated.addListener(async e=>{try{await chrome.sidePanel.setOptions({tabId:e,path:k,enabled:!0})}catch{}N(e).catch(()=>{})});ce();ie();he();ge();we();J().catch(()=>{});addEventListener("unhandledrejection",e=>{var t;console.warn("[bg] unhandledrejection",e.reason),(t=e.preventDefault)==null||t.call(e)});addEventListener("error",e=>{var t;console.warn("[bg] error",(e==null?void 0:e.error)||(e==null?void 0:e.message)),(t=e.preventDefault)==null||t.call(e)});
