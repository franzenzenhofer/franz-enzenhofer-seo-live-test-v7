import{r as w}from"./auth-GnX2ubGu.js";const g="src/offscreen.html",p=async()=>{var t,a;await((a=(t=chrome.offscreen).hasDocument)==null?void 0:a.call(t))||await chrome.offscreen.createDocument({url:g,reasons:["IFRAME_SCRIPTING"],justification:"Run rules asynchronously in isolated doc"})},v=async e=>(await p(),new Promise(t=>{const a=Math.random().toString(36).slice(2),n=o=>{const s=o;(s==null?void 0:s.channel)==="offscreen"&&(s==null?void 0:s.replyTo)===a&&(chrome.runtime.onMessage.removeListener(n),t(s.data))};chrome.runtime.onMessage.addListener(n),chrome.runtime.sendMessage({channel:"offscreen",id:a,data:e})})),c=e=>`results:${e}`,y=async(e,t)=>{const{globalRuleVariables:a,googleApiAccessToken:n}=await chrome.storage.local.get(["globalRuleVariables","googleApiAccessToken"]),o={variables:a||{},googleApiAccessToken:n||null,events:t.ev,rulesUrl:chrome.runtime.getURL("src/sidepanel.html"),codeviewUrl:chrome.runtime.getURL("src/sidepanel.html#codeview")},s=await v({kind:"runTyped",run:t,globals:o}),{[c(e)]:l}=await chrome.storage.local.get(c(e)),f=Array.isArray(l)?[...l,...s]:s;await chrome.storage.local.set({[c(e)]:f})},i=e=>`run:${e}`,d=async e=>{const{[i(e)]:t}=await chrome.storage.session.get(i(e));return t||null},m=async(e,t)=>{await chrome.storage.session.set({[i(e)]:t})},b=async(e,t)=>{const a=await d(e)||{id:Date.now(),ev:[]};a.ev.push(t),await m(e,a)},L=async e=>{const t=await d(e)||{id:Date.now(),ev:[]};t.domDone=!0,await m(e,t)},R=async e=>{const t=await d(e);return await chrome.storage.session.remove(i(e)),t},A=e=>`finalize:${e}`,u=async(e,t=3e3)=>{await chrome.alarms.create(A(e),{when:Date.now()+t})},D=e=>{chrome.alarms.onAlarm.addListener(t=>{t.name.startsWith("finalize:")&&e(Number(t.name.split(":")[1]))})},r=async(e,t)=>{await b(e,t),t.t==="nav:before"&&await chrome.storage.local.remove(`results:${e}`),await u(e)},P=async e=>{await L(e),await u(e,200)};D(async e=>{const t=await R(e);t&&await y(e,t)});const k=()=>{chrome.webNavigation.onBeforeNavigate.addListener(e=>{e.frameId===0&&r(e.tabId,{t:"nav:before",u:e.url})}),chrome.webNavigation.onCommitted.addListener(e=>{e.frameId===0&&r(e.tabId,{t:"nav:commit",u:e.url})}),chrome.webNavigation.onHistoryStateUpdated.addListener(e=>{e.frameId===0&&r(e.tabId,{t:"nav:history",u:e.url})})},q=()=>{const e={urls:["http://*/*","https://*/*"]};chrome.webRequest.onBeforeSendHeaders.addListener(t=>{r(t.tabId,{t:"req:beforeHeaders",u:t.url})},e,["requestHeaders"]),chrome.webRequest.onHeadersReceived.addListener(t=>{const a=Object.fromEntries((t.responseHeaders||[]).map(n=>[n.name,n.value]));r(t.tabId,{t:"req:headers",u:t.url,h:a})},e,["responseHeaders"]),chrome.webRequest.onCompleted.addListener(t=>{r(t.tabId,{t:"req:done",u:t.url,s:t.statusCode})},e)},I=()=>{chrome.runtime.onMessage.addListener((e,t,a)=>{var o,s;const n=(o=t.tab)==null?void 0:o.id;n&&(e!=null&&e.event&&(r(n,{t:`dom:${e.event}`,d:e.data}),e.event==="document_idle"&&P(n)),e==="tabIdPls"&&a({tabId:n,url:(s=t.tab)==null?void 0:s.url}))})},M=async()=>{},h="src/sidepanel.html";chrome.runtime.onInstalled.addListener(()=>{M()});chrome.action.onClicked.addListener(async e=>{e.id&&await chrome.sidePanel.open({tabId:e.id})});chrome.tabs.onActivated.addListener(async({tabId:e})=>{await chrome.sidePanel.setOptions({tabId:e,path:h,enabled:!0})});chrome.tabs.onUpdated.addListener(async e=>{await chrome.sidePanel.setOptions({tabId:e,path:h,enabled:!0})});k();q();I();w().catch(()=>{});
